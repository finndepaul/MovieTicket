@page "/bookinghistorydetail/{Id:guid}"
@layout MovieTicket.BlazorServer.Components.Layout.UserLayout
@using BarcodeStandard
@using System.Drawing
@using MovieTicket.Application.DataTransferObjs.Account
@using MovieTicket.Application.DataTransferObjs.Bill
@using MovieTicket.Application.DataTransferObjs.BillCombo
@using MovieTicket.Application.DataTransferObjs.Ticket
<div class="container my-4">
    <!-- Nút quay lại -->
    <div class="mb-3" style="margin-top: 50px;">
        <button @onclick="GoToUserDetail" class="btn btn-secondary d-flex align-items-center">
            <i class="bi bi-arrow-bar-left me-2" ></i> Quay lại
        </button>
    </div>

    <!-- Thông tin đơn hàng và khách hàng -->
    <div class="row">
        <!-- Thông tin đơn hàng -->
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Thông tin đơn hàng</h5>
                </div>
                <div class="card-body">
                    @if (objBill != null && objShowTime != null)
                    {
                        <p><strong>Mã đơn hàng:</strong> @(objBill?.Id)</p>
                        <p><strong>Phim:</strong> <span class="text-primary">@objShowTime?.FilmName</span></p>
                        <p>
                            <strong>Giờ chiếu:</strong>
                            <span class="badge bg-danger">@objShowTime?.StartTime?.ToString("HH:mm") - @objShowTime?.EndTime?.ToString("HH:mm")</span>
                        </p>
                        <p><strong>Ngày chiếu:</strong> @(objShowTime?.ShowtimeDate?.ToString("dd/MM/yyyy"))</p>
                        <p><strong>Phòng chiếu:</strong> @objShowTime?.CinemaName</p>
                        <p><strong>Rạp chiếu:</strong> <span class="text-primary">@objShowTime?.CinemaCenterName</span></p>
                        <p><strong>Ngày đặt:</strong> @(objBill?.CreateTime?.ToString("dd/MM/yyyy"))</p>
                    }
                    else
                    {
                        <p>Không có dữ liệu</p>
                    }
                </div>
            </div>
        </div>

        <!-- Thông tin khách hàng -->
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Thông tin khách hàng</h5>
                </div>
                <div class="card-body">
                    @if (objAccount != null)
                    {
                        <p><strong>Khách hàng:</strong> @(objAccount?.Name)</p>
                        <p><strong>Điện thoại:</strong> @(objAccount?.Phone)</p>
                        <p><strong>Email:</strong> @(objAccount?.Email)</p>
                        <p><strong>Trạng thái:</strong> <span class="badge bg-success">@objBill?.Status</span></p>
                        <p><strong>Thành tiền:</strong> @(objBill?.TotalMoney?.ToString("#,##0"))</p>
                        <p><strong>Giảm giá:</strong> @((objBill?.TotalMoney - objBill?.AfterDiscount)?.ToString("#,##0"))</p>
                        <p><strong>Tổng tiền:</strong> @(objBill?.AfterDiscount?.ToString("#,##0"))</p>
                    }
                    else
                    {
                        <p>Không có dữ liệu</p>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Ghế & Dịch vụ -->
    <div class="row">
        <!-- Thông tin ghế -->
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Thông tin ghế</h5>
                </div>
                <div class="card-body p-0">
                    <table class="table table-hover table-bordered mb-0">
                        <thead class="table-secondary">
                            <tr>
                                <th>Ghế</th>
                                <th>Loại</th>
                                <th>Giá</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (lstSeat.Count > 0)
                            {
                                @foreach (var seat in lstSeat)
                                {
                                    <tr>
                                        <td>@seat.SeatName</td>
                                        <td>@seat.SeatType</td>
                                        <td>@seat.Price.ToString("#,##0")</td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="3">Không có dữ liệu</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Thông tin dịch vụ -->
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Dịch vụ</h5>
                </div>
                <div class="card-body p-0">
                    <table class="table table-hover table-bordered mb-0">
                        <thead class="table-secondary">
                            <tr>
                                <th>Tên dịch vụ</th>
                                <th>Số lượng</th>
                                <th>Đơn giá</th>
                                <th>Tổng tiền</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (lstBillCombo.Count > 0)
                            {
                                @foreach (var combo in lstBillCombo)
                                {
                                    <tr>
                                        <td>@combo.ComboName</td>
                                        <td>@combo.Quantity</td>
                                        <td>@combo.Price?.ToString("#,##0")</td>
                                        <td>@combo.TotalPrice?.ToString("#,##0")</td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="4">Không có dữ liệu</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>


@code {
	[Parameter] public Guid Id { get; set; }
	private List<TicketDto> lstTicket = new List<TicketDto>();
	private TicketDto objTicket = new TicketDto();
	private ShowTimeDto objShowTime = new ShowTimeDto();
	private class BillSeat
	{
		public string SeatName { get; set; }
		public string SeatType { get; set; }
		public decimal Price { get; set; }
	}
	private class SeatPrice
	{
		public Guid SeatId { get; set; }
		public decimal Price { get; set; }
	}
	private List<BillComboDto> lstBillCombo = new List<BillComboDto>();
	private List<BillSeat> lstSeat = new List<BillSeat>();
	private List<SeatPrice> lstSeatId = new List<SeatPrice>();
	private BillDetailDto objBill = new BillDetailDto();
	private AccountDto objAccount = new AccountDto();

	protected async override Task OnInitializedAsync()
	{
		//lay bill theo id
		objBill = await BillService.GetBillByIdAsync(Id);
		//lay account theo bill id
		objAccount = await AccountService.GetByIdAsync(objBill.MembershipId.Value);
		//lay list ticket theo bill id
		lstTicket = await TicketService.GetListTicketByBillIdAsync(Id);
		//lay 1 ticket dau tien cua bill id do
		objTicket = lstTicket.FirstOrDefault(x => x.BillId == Id);
		//lay showtimeid cua ticket
		var showtimeId = objTicket.ShowTimeId.Value;
		//tim showtime theo id
		var findShowtime = await ShowTimeService.GetById(showtimeId);
		//lay showtime
		objShowTime = findShowtime.Data;
		lstSeatId = lstTicket.Select(x => new SeatPrice
			{
				SeatId = x.SeatId.Value,
				Price = x.Price
			}).ToList();
		foreach (var item in lstSeatId)
		{
			var obj = await SeatService.GetById(item.SeatId);
			var seat = obj.Data;
			lstSeat.Add(new BillSeat
				{
					SeatType = seat.SeatTypeName,
					SeatName = seat.Position,
					Price = item.Price
				});
		}
		lstBillCombo = await BillComboService.GetListBillComboByBillId(Id);
	}

	private void GoToUserDetail()
	{
		NavigationManager.NavigateTo($"/userinformation");
	}
}